<!DOCTYPE html>
<html>
<head>
  <title>Admin - Staff Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="mb-4">üë®‚Äçüíº Admin ‚Äì All Staff</h2>

  <table class="table table-bordered bg-white">
    <thead>
      
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Department</th>
        <th>Device ID</th>
        <th>Action</th>
      </tr>
      <td>
  <button class="btn btn-primary btn-sm" onclick="openEditModal('${staff._id}', '${staff.email}')">
    Edit
  </button>

  <button class="btn btn-danger btn-sm" onclick="deleteStaff('${staff._id}')">
    Delete
  </button>
</td>

    </thead>
    <tbody id="staffTable"></tbody>
  </table>

</div>

<!-- ‚úÖ Edit Staff Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Staff</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editStaffId">

        <div class="mb-3">
          <label>New Email</label>
          <input type="email" id="editEmail" class="form-control">
        </div>

        <div class="mb-3">
          <label>New Password (optional)</label>
          <input type="password" id="editPassword" class="form-control">
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="updateStaff()">Save Changes</button>
      </div>

    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const BASE_URL = "https://nbc-boa-attendance-system.onrender.com";

async function loadStaff() {
  try {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE_URL}/api/admin/staff`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!res.ok) {
      throw new Error("Unauthorized");
    }

    const data = await res.json();
    const table = document.getElementById('staffTable');
    table.innerHTML = "";

    data.forEach(staff => {
      table.innerHTML += `
        <tr>
          <td>${staff.name}</td>
          <td>${staff.email}</td>
          <td>${staff.department || 'N/A'}</td>
          <td>${staff.deviceId || 'Not set'}</td>
          <td>
            <button class="btn btn-primary btn-sm"
              onclick="openEditModal('${staff._id}', '${staff.email}')">
              Edit
            </button>

            <button class="btn btn-danger btn-sm"
              onclick="deleteStaff('${staff._id}')">
              Delete
            </button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    alert("Unauthorized or session expired. Please login again.");
    window.location.href = "admin-login.html";
  }
}


// ‚úÖ DELETE STAFF
async function deleteStaff(id) {
  if(!confirm("Are you sure you want to delete this staff?")) return;

  try {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE_URL}/api/admin/staff/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const data = await res.json();
    alert(data.message);

    loadStaff();

  } catch (err) {
    alert("Failed to delete");
  }
}


// ‚úÖ OPEN EDIT MODAL
function openEditModal(id, email){
  document.getElementById("editStaffId").value = id;
  document.getElementById("editEmail").value = email;
  document.getElementById("editPassword").value = "";

  const modal = new bootstrap.Modal(document.getElementById("editModal"));
  modal.show();
}


// ‚úÖ UPDATE STAFF
async function updateStaff(){
  const id = document.getElementById("editStaffId").value;
  const email = document.getElementById("editEmail").value;
  const password = document.getElementById("editPassword").value;

  try {
    const token = localStorage.getItem("token");

    const res = await fetch(`${BASE_URL}/api/admin/staff/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    alert(data.message);

    const modal = bootstrap.Modal.getInstance(document.getElementById("editModal"));
    modal.hide();

    loadStaff();

  } catch (err) {
    alert("Error updating staff");
  }
}


// ‚úÖ PROTECT PAGE IF NOT LOGGED IN
if (!localStorage.getItem("token")) {
  window.location.href = "admin-login.html";
}

loadStaff();
</script>
