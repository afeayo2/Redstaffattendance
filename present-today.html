<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Present | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
      padding: 2rem;
    }

    h1 {
      color: #e60012;
      font-weight: 700;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .card {
      border-radius: 15px;
      padding: 1.5rem;
    }

    thead tr {
      background-color: #e60012;
      color: #fff;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .pagination {
      justify-content: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<h1><i class="bi bi-people-fill"></i> Staff Present</h1>

<div class="card">

  <!-- ✅ CONTROLS 
  <div class="controls">
    <button class="btn btn-danger" onclick="setToday()">Today</button>

    <select class="form-select w-auto" id="modeSelector" onchange="changeMode()">
      <option value="day">Day</option>
      <option value="week">Week</option>
      <option value="month">Month</option>
    </select>

    <input type="month" id="monthInput" class="form-control w-auto d-none" onchange="loadStaff()" />
    <input type="week" id="weekInput" class="form-control w-auto d-none" onchange="loadStaff()" />

  </div>-->

  <!-- ✅ TABLE -->
   <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">

  <div>
    <button onclick="setToday()" class="btn btn-danger me-2">Today</button>
    <button onclick="setWeek()" class="btn btn-outline-danger me-2">This Week</button>
    <button onclick="downloadExcel()" class="btn btn-success">
  <i class="bi bi-file-earmark-excel"></i> Download Report
</button>

  </div>

  <div class="d-flex gap-2">
    <select id="monthSelect" class="form-select">
      <option value="1">January</option>
      <option value="2">February</option>
      <option value="3">March</option>
      <option value="4">April</option>
      <option value="5">May</option>
      <option value="6">June</option>
      <option value="7">July</option>
      <option value="8">August</option>
      <option value="9">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>

    <select id="yearSelect" class="form-select">
      <option value="2024">2024</option>
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
    </select>

    <button onclick="setMonth()" class="btn btn-outline-danger">Filter</button>
  </div>

</div>

<div id="pagination" class="my-4 text-center"></div>
<div class="d-flex gap-3 mb-3">
  <span class="badge bg-success fs-6">Present: <span id="presentCount">0</span></span>
  <span class="badge bg-danger fs-6">Absent: <span id="absentCount">0</span></span>
</div>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Office</th>
          <th>Check-In Time</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="attendanceTable">
        <tr>
          <td colspan="5" class="text-center p-4">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ✅ PAGINATION -->
  <nav>
    <ul class="pagination">
      <li class="page-item">
        <button class="page-link" onclick="prevPage()">Prev</button>
      </li>

      <li class="page-item disabled">
        <span class="page-link" id="pageInfo">Page 1</span>
      </li>

      <li class="page-item">
        <button class="page-link" onclick="nextPage()">Next</button>
      </li>
    </ul>
  </nav>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  const token = localStorage.getItem('token');
  const attendanceTable = document.getElementById('attendanceTable');

  let mode = "day";
  let page = 1;
  const limit = 10;
  let selectedMonth = new Date().getMonth() + 1;
  let selectedYear = new Date().getFullYear();

  async function loadPresentStaff() {
    try {
      let url = `https://nbc-boa-attendance-system.onrender.com/api/admin/present?mode=${mode}&page=${page}&limit=${limit}`;

      if (mode === "month") {
        url += `&month=${selectedMonth}&year=${selectedYear}`;
      }

      const res = await fetch(url, {
        headers: { Authorization: 'Bearer ' + token }
      });

      if (!res.ok) throw new Error('Failed to fetch');

      const data = await res.json();

      renderTable(data.records);
      renderPagination(data.page, data.totalPages);

    } catch (err) {
      attendanceTable.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Error loading records</td></tr>`;
    }
  }

  function renderTable(data) {
    if (!data || data.length === 0) {
      attendanceTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No records found</td></tr>`;
      return;
      document.getElementById("presentCount").innerText = data.presentCount || data.records.length;
document.getElementById("absentCount").innerText = data.absentCount || 0;
    }

    attendanceTable.innerHTML = data.map(staff => `
      <tr>
        <td>${staff.name}</td>
        <td>${staff.email}</td>
        <td>${staff.office}</td>
        <td>${new Date(staff.checkInTime).toLocaleString()}</td>
        <td>${staff.latitude?.toFixed(4) || 'N/A'}, ${staff.longitude?.toFixed(4) || 'N/A'}</td>
      </tr>
    `).join('');
  }
;


  function renderPagination(current, totalPages) {
    const paginationDiv = document.getElementById("pagination");

    if (totalPages <= 1) {
      paginationDiv.innerHTML = "";
      return;
    }

    let buttons = "";

    if (current > 1) {
      buttons += `<button onclick="changePage(${current - 1})" class="btn btn-outline-danger">Prev</button>`;
    }

    buttons += `<span class="mx-3 fw-bold">Page ${current} of ${totalPages}</span>`;

    if (current < totalPages) {
      buttons += `<button onclick="changePage(${current + 1})" class="btn btn-outline-danger">Next</button>`;
    }

    paginationDiv.innerHTML = buttons;
  }

  function changePage(p) {
    page = p;
    loadPresentStaff();
  }


function downloadExcel() {
  let table = document.querySelector("table");
  let workbook = XLSX.utils.table_to_book(table, { sheet: "Attendance" });
  XLSX.writeFile(workbook, "Attendance.xlsx");
}



  // ✅ FILTER BUTTONS
  function setToday() {
    mode = "day";
    page = 1;
    loadPresentStaff();
  }

  function setWeek() {
    mode = "week";
    page = 1;
    loadPresentStaff();
  }

  function setMonth() {
    mode = "month";
    page = 1;
    selectedMonth = document.getElementById('monthSelect').value;
    selectedYear = document.getElementById('yearSelect').value;
    loadPresentStaff();
  }

  
  window.onload = loadPresentStaff;
</script>

</body>
</html>
